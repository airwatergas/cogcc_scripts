#!/Users/troyburke/.rvm/rubies/ruby-2.1.2/bin/ruby

# COGCC Bradenhead Test Report Downloader

# DOWNLOAD LINK => http://ogccweblink.state.co.us/DownloadDocument.aspx?DocumentId=_document_id_

# UNIX shell script to run scraper: while true; do ./download_bradenhead_test_pdf.rb & sleep 10; done

# Include required classes and models:

require '../public_data_config'

require 'rubygems'
require 'active_record'
require 'pg'
require 'mechanize'

# Include database table models:

mappings_directory = getMappings

require mappings_directory + 'bradenhead_tests'

# begin error trapping
begin

  start_time = Time.now

  # Establish a database connection
  ActiveRecord::Base.establish_connection( { adapter: 'postgresql', host: getDBHost, port: getDBPort, username: getDBUsername, database: getDBDatabase, schema_search_path: getDBSchema } )

  # use random browser
  agent_aliases = [ 'Windows IE 7', 'Windows Mozilla', 'Mac Safari', 'Mac FireFox', 'Mac Mozilla', 'Linux Mozilla', 'Linux Firefox' ]
  agent_alias = agent_aliases[rand(0..6)]

  agent = Mechanize.new { |agent| agent.user_agent_alias = agent_alias }

  puts agent_alias

  if BradenheadTests.where(in_use: true).count == 0 then

  BradenheadTests.find_by_sql("SELECT * FROM bradenhead_tests WHERE in_use IS FALSE AND qc_pdf_downloaded IS FALSE AND document_number IN 
(400499992,400088348,2608979,400292411,400609579,400295253,400290165,400740178,1796764,400526609,400734947,400155659,1625025,400284991,400504051,400288047,400301222,400384136,400289143,400365426,400289503,400289535,400292340,400289358,400289516,400289368,400289295,400289270,400290239,400493600,400292402,400105588,400289460,400288804,400289474,400288718,400292294,400316690,400659903,400671736,400437918,400660504,400671741,400365403,400289468,400292302,400289494,400768697,400288959,400289005,400768709,400318120,400365515,400290201,400598707,400292406,400356508,400292438,400292337,400493617,400351543,400289383,400292285,400290171,400288838,400290174,400292391,400289352,400155623,400155795,400143557,400289329,400289210,400292312,400318064,400289345,400290160,400351499,400288941,400292377,400292264,400292260,400719391,400293722,400365481,400143413,400292384,400292287,400292447,400290193,400724916,400290183,400689846,400292345,400365547,400469463,400769690,400470717,400469455,400462953,400485049,400603417,400676382,400734579,400155751,400437318,400730389,400289332,400289453,400347113,400436237,400469411,400728312,400734852,400647438,400499574,400526787,400741349,400285213,400734868,400524166,400660470,400660688,400521477,400647616,400768670,400769662,400734919,400521420,400659449,400521475,400640989,400527464,400754027,400722463,400730346,400488405,400519368,400292339,400741898,400489436,400489462,400766712,400469449,400521384,400646839,400647648,400368587,400508660,400155794,400155483,400524140,400751110,400563791,400500353,400350975,400422359,400347290,400754009,400734873,400500337,400431714,400734931,400647555,400755039,400774277,400289487,400741255,400292416,400526796,400498570,400424394,400527586,400755029,400728525,400499287) ORDER BY id LIMIT 1").each do |doc|

#(2486685,2511219,400041474,400143596,400155471,400155936,400749519,400499341,400155551,400143468,400155792,400640336,400436046,400498554,400384967,400155894,400155626,400143528,400143425,400155834,400155453,400059126,400088827,400083637,400155729,400143575,400155582,2608970,400143567,400155909,400155524,400072859,400080446,400286614,400433166,400322027,400417763,400080176,400061883,400079995,400041600,400064389,400384261,400647333,400646858,400537544,400537533,400078349,400766264,400408299,400767434,400155625,400155353,400143373,400061087,400671763,400080369,400384564,400734976,400645161,400330224,400367017,400644991,400527840,400432732,400288032,400734927,400354720,400484877,400369690,1448194,400357616,400492003,400492575,400640918,400350967,400527771,400752171,400640833,400607318,400385568,400526699,2468667,400478854,400525791,400287880,400526799,400724911,400479137,400652324,400499303,400364763,400353098,400442082,400476835,400492012,400436039,400366854,400354866,400727244,400407997,400689641,400734537,400351623,400689607,400476900,400689572,400456412,400603338,400506219,400565373,400483667,400603141,400586357,400602113,400602099,400586414,400602766,400659950,400593940,400316885,400381234,400729049,400565440,400740235,400349898,400725080,400373026,400431159,400509779,400484883,400603321,400741536,400740329,400382595,400478984,400647469,400539788,400444784,400722387,400774062,400727501,400746476)

    doc.in_use = true
    doc.save!

    download_link = "http://ogccweblink.state.co.us/DownloadDocument.aspx?DocumentId=#{doc.document_id}"

    puts download_link

    dst = agent.get(download_link)

    file_name = "qc98_bradenhead_tests/bradenhead_#{doc.well_api_number}_#{doc.document_number}.pdf"

    puts file_name

    dst.save file_name

    doc.in_use = false
    doc.qc_pdf_downloaded = true
    doc.save!

    puts "Document downloaded!"

  end

  end # in use check

  puts "Time Start: #{start_time}"
  puts "Time End: #{Time.now}"

  rescue Exception => e
    puts e.message
  end
#end